generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String    @id @default(cuid())
  address             String    @unique
  username            String
  domain              String
  passwordHash        String    @map("password_hash")
  publicKey           String?   @map("public_key")
  privateKeyEncrypted String?   @map("private_key_encrypted")
  storageUsed         BigInt    @default(0) @map("storage_used")
  storageLimit        BigInt    @default(1073741824) @map("storage_limit")
  createdAt           DateTime  @default(now()) @map("created_at")
  lastLogin           DateTime? @map("last_login")
  isActive            Boolean   @default(true) @map("is_active")

  sentMails     Mail[]          @relation("SentMails")
  receivedMails MailRecipient[]

  @@index([address])
  @@map("users")
}

model Mail {
  id               String    @id @default(cuid())
  threadId         String?   @map("thread_id")
  version          Int       @default(1)
  fromAddress      String    @map("from_address")
  subject          String?
  content          Json
  attachments      Json?
  reactions        Json?
  poll             Json?
  collaborative    Json?
  encryption       Json?
  versions         Json?
  metadata         Json?
  createdAt        DateTime  @default(now()) @map("created_at")
  sentAt           DateTime? @map("sent_at")
  deliveredAt      DateTime? @map("delivered_at")
  firstReadAt      DateTime? @map("first_read_at")
  lastModifiedAt   DateTime  @default(now()) @updatedAt @map("last_modified_at")
  isDraft          Boolean   @default(false) @map("is_draft")
  isStarred        Boolean   @default(false) @map("is_starred")
  isArchived       Boolean   @default(false) @map("is_archived")
  isSpam           Boolean   @default(false) @map("is_spam")
  isEdited         Boolean   @default(false) @map("is_edited")
  requiresResponse Boolean   @default(false) @map("requires_response")

  sender     User            @relation("SentMails", fields: [fromAddress], references: [address])
  recipients MailRecipient[]

  @@index([fromAddress])
  @@index([threadId])
  @@index([createdAt])
  @@map("mails")
}

model MailRecipient {
  mailId           String    @map("mail_id")
  recipientAddress String    @map("recipient_address")
  type             String
  readAt           DateTime? @map("read_at")

  mail Mail @relation(fields: [mailId], references: [id], onDelete: Cascade)
  user User @relation(fields: [recipientAddress], references: [address])

  @@id([mailId, recipientAddress])
  @@index([recipientAddress])
  @@map("mail_recipients")
}
